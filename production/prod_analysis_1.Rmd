---
title: "Data analysis"
date: "`r format(Sys.time(), '%A %d %B %Y %X')`"
css: "../input/css/custom.css"
output:
  bookdown::html_document2:
    number_sections: true
    toc: true
    toc_float:
      collapsed: false
      toc_depth: 2
    code_folding: "hide"
editor_options: 
  chunk_output_type: console
---

```{r include=FALSE}
knitr::opts_chunk$set(warning = FALSE,message = FALSE, cache = FALSE,results = "hold")
knitr::opts_knit$set(root.dir = "../")
options(scipen=999)
rm(list=ls())
options(knitr.kable.NA = '')
Sys.setlocale("LC_MESSAGES", 'es_CL.UTF-8')
Sys.setenv(LANG = "es_CL.UTF-8")
```


1. Higher status vignettes will obtain a larger preferred income tax. 
  - Education [NO]
  - Income [YES]
2. Respondents of lower status will perceive lower income tax.
  - Education [YES]
3. Respondents of higher status will prefer less income tax than those of lower status
4. Respondents that support meritocratic ideals will prefer less income tax.
5. Results will remain stable over time (two waves) 

# Wave 1

```{r}
# Funciones para renderizar tablas tanto en HTML como en pdf
 if (!require("pacman")) install.packages("pacman")  #si falta pacman, instalar
 if (!require("tinytex")) install.packages("tinytex")#si falta tinytex, instalar
 pacman::p_load(dplyr) # librerias
load("input/data/proc/vig_respw01.RData")


df1 <- vig_respw01 %>% 
  mutate(
    perc1=taxperc+1,
    just1=taxjust+1,
    lnperc1 = log(perc1),
    lnjust1 = log(just1),
    # percR=car::recode(taxperc,"lo:1000=NA"),
    # justR=car::recode(taxjust,"lo:1000=NA"),
    # lnpercR=log(percR),
    # lnjustR=log(justR)
         ) %>% 
    select(
      # perc1,just1,
      # percR,justR,
      lnperc1,lnjust1,
      # lnpercR,lnjustR,
           sexo_vig,edad_vig,
         apellido_vig,nse_ori_vig,
         necesidades_vig,
         ingresos_vig,educ_madre_vig,hhincome,educ) 

sjPlot::plot_frq(data = df1$lnperc1,type = "histogram",show.mean = T)

cormat1 <- polycor::hetcor(data = df1,parallel = T)$correlations

corrplot::corrplot(cormat1,
    method = "color",
    addCoef.col = "#000390",
    type = "upper",
    tl.col = "black",
    col=colorRampPalette(c("white","#0068DC"))(12),
    bg = "white",
    na.label = "-")
```


```{r perc-w01}
# Funciones para renderizar tablas tanto en HTML como en pdf
 if (!require("pacman")) install.packages("pacman")  #si falta pacman, instalar
 if (!require("tinytex")) install.packages("tinytex")#si falta tinytex, instalar
 pacman::p_load(dplyr,lme4,texreg,ggridges) # librerias
load("input/data/proc/vig_respw01.RData")


df1 <- vig_respw01 %>% 
  mutate(
    perc1 = (1 + taxperc),
    just1 = (1 + taxjust),
    perc01 = (.01 + taxperc),
    just01 = (.01 + taxjust),    
    lnperc1 = log(perc1),
    lnjust1 = log(just1),
    lnperc01 = log(perc01),
    lnjust01 = log(just01),    
    lnperc = log(taxperc),
    lnjust = log(taxjust),
    percarch = log(taxperc + sqrt(taxperc ^ 2 + 1)),
    justarch = log(taxjust + sqrt(taxjust ^ 2 + 1)),
    # percR=car::recode(taxperc,"lo:1000=NA"),
    # justR=car::recode(taxjust,"lo:1000=NA"),
    # lnpercR=log(percR),
    # lnjustR=log(justR)
         ) %>% 
  dplyr::select(respondeid,folio_encuestado_1,deck,
         taxperc,
         taxjust,
         perc1, just1,
         perc01,just01,
         # percR,justR,
         lnperc1, lnjust1,
         lnperc01, lnjust01,         
         # lnpercR,lnjustR,
         percarch, justarch,
         sexo_vig, edad_vig,
         apellido_vig, nse_ori_vig, educ_madre_vig,
         necesidades_vig,
         ingresos_vig, educ_vig,sexo_re,edad_re,
         income5, educ) %>% 
  na.omit() %>% 
  arrange(taxjust,taxperc)
dim(df1)
sjmisc::frq(df1$ingresos_vig)
# Hypothesis: Perceived tax --------------------------------------------------------
m1 <- "sexo_vig+edad_vig"
m2 <- "apellido_vig+nse_ori_vig + educ_madre_vig"
m3 <- "educ_vig + ingresos_vig + necesidades_vig"
m5 <- "income5 + educ + sexo_re + edad_re"
m6 <- "sexo_vig+edad_vig + apellido_vig+nse_ori_vig + educ_madre_vig + educ_vig + ingresos_vig + necesidades_vig+income5 + educ + sexo_re + edad_re"
m7 <- "sexo_vig+edad_vig + apellido_vig+nse_ori_vig + educ_madre_vig + educ_vig + ingresos_vig + necesidades_vig+income5 + educ + sexo_re + edad_re +deck"

hipotesis <- c(m1,m2,m3,m5,m6,m7)
# Set the independent variables (IVs)
ivs<- df1 %>% dplyr::select(lnperc1,lnperc01,percarch) %>% names()

# Create the object for each model
models <- list()
for (i in ivs) {
models[[i]] <- paste0(i,"~",hipotesis,"+(1|folio_encuestado_1)")  
}

# Estimate the multilevel models
fits <- list()
for (i in ivs) {
  for (z in models[[i]][1:length(hipotesis)]) {
    fits[[z]] <- lme4::lmer(formula = z, data = df1)
  }
}
fit_pt1 <- fits
# change model names within list
names(fit_pt1) <- paste0(rep(ivs,each=length(hipotesis)),1:length(hipotesis))
save(fit_pt1,file = here::here("input/data/proc/fit_pt1.RData"))
sjPlot::tab_model(fit1[c("lnperc16","lnperc016","percarch6")],show.ci = F,wrap.labels = 200,p.style = "stars")
```

```{r just-w01}
# Funciones para renderizar tablas tanto en HTML como en pdf
 if (!require("pacman")) install.packages("pacman")  #si falta pacman, instalar
 if (!require("tinytex")) install.packages("tinytex")#si falta tinytex, instalar
 pacman::p_load(dplyr,lme4,texreg,ggridges,MASS) # librerias
load("input/data/proc/vig_respw01.RData")

df1 <- vig_respw01 %>% 
  mutate(
    perc1 = (1 + taxperc),
    just1 = (1 + taxjust),
    perc01 = (.01 + taxperc),
    just01 = (.01 + taxjust),    
    lnperc1 = log(perc1),
    lnjust1 = log(just1),
    lnperc01 = log(perc01),
    lnjust01 = log(just01),    
    lnperc = log(taxperc),
    lnjust = log(taxjust),
    percarch = log(taxperc + sqrt(taxperc ^ 2 + 1)),
    justarch = log(taxjust + sqrt(taxjust ^ 2 + 1)),
    # percR=car::recode(taxperc,"lo:1000=NA"),
    # justR=car::recode(taxjust,"lo:1000=NA"),
    # lnpercR=log(percR),
    # lnjustR=log(justR)
         ) %>% 
  dplyr::select(respondeid,folio_encuestado_1,deck,
         taxperc,
         taxjust,
         perc1, just1,
         perc01,just01,
         # percR,justR,
         lnperc1, lnjust1,
         lnperc01, lnjust01,         
         # lnpercR,lnjustR,
         percarch, justarch,
         sexo_vig, edad_vig,
         apellido_vig, nse_ori_vig, educ_madre_vig,
         necesidades_vig,
         ingresos_vig, educ_vig,sexo_re,edad_re,
         income5, educ) %>% 
  na.omit() %>% 
  arrange(taxjust,taxperc)
dim(df1)

# Hypothesis: Just tax --------------------------------------------------------
m1 <- "sexo_vig+edad_vig"
m2 <- "apellido_vig+nse_ori_vig + educ_madre_vig"
m3 <- "educ_vig + ingresos_vig + necesidades_vig"
m4 <- "lnperc1"
m5 <- "income5 + educ + sexo_re + edad_re"
m6 <- "sexo_vig+edad_vig + apellido_vig+nse_ori_vig + educ_madre_vig + educ_vig + ingresos_vig + necesidades_vig+lnperc1 +income5 + educ + sexo_re + edad_re + deck"

hipotesis <- c(m1,m2,m3,m4,m5,m6)
# Set the independent variables (IVs)
ivs<- df1 %>% dplyr::select(lnjust1,lnjust01,justarch) %>% names()

# Create the object for each model
models <- list()
for (i in ivs) {
models[[i]] <- paste0(i,"~",hipotesis,"+(1|folio_encuestado_1)")  
}

# Estimate the multilevel models
fits <- list()
for (i in ivs) {
  for (z in models[[i]][1:length(hipotesis)]) {
    fits[[z]] <- lme4::lmer(formula = z, data = df1)
  }
}
fit_jt1 <- fits
# change model names within list
names(fit_jt1) <- paste0(rep(ivs,each=length(hipotesis)),1:length(hipotesis))
save(fit_jt1,file = here::here("input/data/proc/fit_jt1.RData"))
sjPlot::tab_model(fit_jt1[c("lnjust16","lnjust016","justarch6")],show.ci = F,wrap.labels = 200,p.style = "stars")
```

```{r just-histo}
# Funciones para renderizar tablas tanto en HTML como en pdf
 if (!require("pacman")) install.packages("pacman")  #si falta pacman, instalar
 if (!require("tinytex")) install.packages("tinytex")#si falta tinytex, instalar
 pacman::p_load(dplyr,lme4,texreg,ggridges,MASS) # librerias
load("input/data/proc/vig_respw01.RData")

df1 <- vig_respw01 %>% 
  mutate(
    perc1 = (1 + taxperc),
    just1 = (1 + taxjust),
    perc01 = (.01 + taxperc),
    just01 = (.01 + taxjust),    
    lnperc1 = log(perc1),
    lnjust1 = log(just1),
    lnperc01 = log(perc01),
    lnjust01 = log(just01),    
    lnperc = log(taxperc),
    lnjust = log(taxjust),
    percarch = log(taxperc + sqrt(taxperc ^ 2 + 1)),
    justarch = log(taxjust + sqrt(taxjust ^ 2 + 1)),
    # percR=car::recode(taxperc,"lo:1000=NA"),
    # justR=car::recode(taxjust,"lo:1000=NA"),
    # lnpercR=log(percR),
    # lnjustR=log(justR)
         ) %>% 
  dplyr::select(respondeid,folio_encuestado_1,deck,
         taxperc,
         taxjust,
         perc1, just1,
         perc01,just01,
         # percR,justR,
         lnperc1, lnjust1,
         lnperc01, lnjust01,         
         # lnpercR,lnjustR,
         percarch, justarch,
         sexo_vig, edad_vig,
         apellido_vig, nse_ori_vig, educ_madre_vig,
         necesidades_vig,
         ingresos_vig, educ_vig,sexo_re,edad_re,
         income5, educ) %>% 
  na.omit() %>% 
  arrange(taxjust,taxperc)
dim(df1)

j1 <- 
df1 %>% 
  dplyr::select(income=justarch) %>% 
  mutate(Variable="Preferences")

p1 <- 
df1 %>% dplyr::select(income=percarch) %>% 
    mutate(Variable="Perceptions")


df_taxes <- bind_rows(j1,p1) 

ggplot(df_taxes) +
  geom_density(aes(x=income,fill=Variable), alpha=0.4) +
  scale_x_continuous(name = "Income tax",limits = c(0,20)) +
  theme(legend.position="bottom") +
  ylab("Density")

ggsave(plot = last_plot(),filename = "tax_density.png",device = "png",
       path = here::here("output"),width = 1,height = 1,units = "cm",scale = 12)

```

```{r checks}
# Funciones para renderizar tablas tanto en HTML como en pdf
 if (!require("pacman")) install.packages("pacman")  #si falta pacman, instalar
 if (!require("tinytex")) install.packages("tinytex")#si falta tinytex, instalar
 pacman::p_load(dplyr,lme4,texreg,ggridges,MASS) # librerias
load("input/data/proc/vig_respw01.RData")
load("input/data/proc/vig_respw02.RData")

df1 <- vig_respw01 %>% 
  mutate(
    perc1 = (1 + taxperc),
    just1 = (1 + taxjust),
    perc01 = (.01 + taxperc),
    just01 = (.01 + taxjust),    
    lnperc1 = log(perc1),
    lnjust1 = log(just1),
    lnperc01 = log(perc01),
    lnjust01 = log(just01),    
    lnperc = log(taxperc),
    lnjust = log(taxjust),
    percarch = log(taxperc + sqrt(taxperc ^ 2 + 1)),
    justarch = log(taxjust + sqrt(taxjust ^ 2 + 1)),
    # percR=car::recode(taxperc,"lo:1000=NA"),
    # justR=car::recode(taxjust,"lo:1000=NA"),
    # lnpercR=log(percR),
    # lnjustR=log(justR)
         ) %>% 
  dplyr::select(respondeid,folio_encuestado_1,deck,
         taxperc,
         taxjust,
         perc1, just1,
         perc01,just01,
         # percR,justR,
         lnperc1, lnjust1,
         lnperc01, lnjust01,         
         # lnpercR,lnjustR,
         percarch, justarch,
         sexo_vig, edad_vig,
         apellido_vig, nse_ori_vig, educ_madre_vig,
         necesidades_vig,
         ingresos_vig, educ_vig,sexo_re,edad_re,
         income5, educ) %>% 
  na.omit() %>% 
  arrange(taxjust,taxperc)


df2 <- vig_respw02 %>% 
  mutate(
    perc1 = (1 + taxperc),
    just1 = (1 + taxjust),
    perc01 = (.01 + taxperc),
    just01 = (.01 + taxjust),    
    lnperc1 = log(perc1),
    lnjust1 = log(just1),
    lnperc01 = log(perc01),
    lnjust01 = log(just01),    
    lnperc = log(taxperc),
    lnjust = log(taxjust),
    percarch = log(taxperc + sqrt(taxperc ^ 2 + 1)),
    justarch = log(taxjust + sqrt(taxjust ^ 2 + 1)),
    # percR=car::recode(taxperc,"lo:1000=NA"),
    # justR=car::recode(taxjust,"lo:1000=NA"),
    # lnpercR=log(percR),
    # lnjustR=log(justR)
         ) %>% 
  dplyr::select(respondeid,folio_encuestado_1,deck,
         taxperc,
         taxjust,
         perc1, just1,
         perc01,just01,
         # percR,justR,
         lnperc1, lnjust1,
         lnperc01, lnjust01,         
         # lnpercR,lnjustR,
         percarch, justarch,
         sexo_vig, edad_vig,
         apellido_vig, nse_ori_vig, educ_madre_vig,
         necesidades_vig,
         ingresos_vig, educ_vig,sexo_re,edad_re,
         income5, educ) %>% 
  na.omit() %>% 
  arrange(taxjust,taxperc)


prop.table(table(df1$taxperc==0))
prop.table(table(df1$taxperc==0,df1$ingresos_vig))*100

prop.table(table(df2$taxperc==0))
prop.table(table(df2$taxperc==0,df2$ingresos_vig))*100


sjPlot::tab_xtab(var.row = df1$taxperc==0,var.col = df1$ingresos_vig,show.cell.prc = T)
sjPlot::tab_xtab(var.row = df2$taxperc==0,var.col = df2$ingresos_vig,show.cell.prc = T)


sjPlot::tab_xtab(var.row = df1$taxjust==0,var.col = df1$ingresos_vig,show.cell.prc = T)
sjPlot::tab_xtab(var.row = df2$taxjust==0,var.col = df2$ingresos_vig,show.cell.prc = T)

df1_decks <- 
df1 %>% group_by(folio_encuestado_1) %>% summarise(deck1=mean(deck)) 

df2_decks <- 
df2 %>% group_by(folio_encuestado_1) %>% summarise(deck2=mean(deck)) 

df_decks <- left_join(df1_decks,df2_decks) %>% na.omit()
df_decks$same_deck <- df_decks$deck1==df_decks$deck2
dim(df_decks)
table(df_decks$same_deck)
```


# Wave 2

```{r corr-w02}
# Funciones para renderizar tablas tanto en HTML como en pdf
 if (!require("pacman")) install.packages("pacman")  #si falta pacman, instalar
 if (!require("tinytex")) install.packages("tinytex")#si falta tinytex, instalar
 pacman::p_load(dplyr) # librerias
load("input/data/proc/vig_respw02.RData")


df2 <- vig_respw02 %>% 
  dplyr::mutate(
    perc1=taxperc+1,
    just1=taxjust+1,
    lnperc1 = log(perc1),
    lnjust1 = log(just1),
    # percR=car::recode(taxperc,"lo:1000=NA"),
    # justR=car::recode(taxjust,"lo:1000=NA"),
    # lnpercR=log(percR),
    # lnjustR=log(justR)
         ) %>% 
    dplyr::select(
      # perc1,just1,
      # percR,justR,
      lnperc1,lnjust1,
      # lnpercR,lnjustR,
           sexo_vig,edad_vig,
         apellido_vig,nse_ori_vig,
         necesidades_vig,
         ingresos_vig,educ_madre_vig,hhincome,educ) 

sjPlot::plot_frq(data = df2$lnperc1,type = "histogram",show.mean = T)

cormat1 <- polycor::hetcor(data = df2,parallel = T)$correlations

corrplot::corrplot(cormat1,
    method = "color",
    addCoef.col = "#000390",
    type = "upper",
    tl.col = "black",
    col=colorRampPalette(c("white","#0068DC"))(12),
    bg = "white",
    na.label = "-")
```

```{r perc-w02}
# Funciones para renderizar tablas tanto en HTML como en pdf
 if (!require("pacman")) install.packages("pacman")  #si falta pacman, instalar
 if (!require("tinytex")) install.packages("tinytex")#si falta tinytex, instalar
 pacman::p_load(dplyr,lme4,texreg,ggridges) # librerias
# load(file = here::here("input/data/proc/foliosw1w2.RData"))
load("input/data/proc/vig_respw02.RData")

df2 <- vig_respw02 %>% 
  # filter(folio_encuestado_1 %in% folios) %>%
  mutate(
    perc1 = (1 + taxperc),
    just1 = (1 + taxjust),
    perc01 = (.01 + taxperc),
    just01 = (.01 + taxjust),    
    lnperc1 = log(perc1),
    lnjust1 = log(just1),
    lnperc01 = log(perc01),
    lnjust01 = log(just01),    
    lnperc = log(taxperc),
    lnjust = log(taxjust),
    percarch = log(taxperc + sqrt(taxperc ^ 2 + 1)),
    justarch = log(taxjust + sqrt(taxjust ^ 2 + 1)),
    # percR=car::recode(taxperc,"lo:1000=NA"),
    # justR=car::recode(taxjust,"lo:1000=NA"),
    # lnpercR=log(percR),
    # lnjustR=log(justR)
         ) %>% 
  dplyr::select(respondeid,folio_encuestado_1,deck,
         taxperc,
         taxjust,
         perc1, just1,
         perc01,just01,
         # percR,justR,
         lnperc1, lnjust1,
         lnperc01, lnjust01,         
         # lnpercR,lnjustR,
         percarch, justarch,
         sexo_vig, edad_vig,
         apellido_vig, nse_ori_vig, educ_madre_vig,
         necesidades_vig,
         ingresos_vig, educ_vig,sexo_re,edad_re,
         income5, educ) %>% 
  na.omit() %>% 
  arrange(taxjust,taxperc)
dim(df2)

# Hypothesis: Perceived tax --------------------------------------------------------
m1 <- "sexo_vig+edad_vig"
m2 <- "apellido_vig+nse_ori_vig + educ_madre_vig"
m3 <- "educ_vig + ingresos_vig + necesidades_vig"
m5 <- "income5 + educ + sexo_re + edad_re"
m6 <- "sexo_vig+edad_vig + apellido_vig+nse_ori_vig + educ_madre_vig + educ_vig + ingresos_vig + necesidades_vig+income5 + educ + sexo_re + edad_re"
m7 <- "sexo_vig+edad_vig + apellido_vig+nse_ori_vig + educ_madre_vig + educ_vig + ingresos_vig + necesidades_vig+income5 + educ + sexo_re + edad_re + deck"

hipotesis <- c(m1,m2,m3,m5,m6,m7)
# Set the independent variables (IVs)
ivs<- df2 %>% dplyr::select(lnperc1,lnperc01,percarch) %>% names()

# Create the object for each model
models <- list()
for (i in ivs) {
models[[i]] <- paste0(i,"~",hipotesis,"+(1|folio_encuestado_1)")  
}

# Estimate the multilevel models
fits <- list()
for (i in ivs) {
  for (z in models[[i]][1:length(hipotesis)]) {
    fits[[z]] <- lme4::lmer(formula = z, data = df2)
  }
}
fit_pt2 <- fits
# change model names within list
names(fit_pt2) <- paste0(rep(ivs,each=length(hipotesis)),1:length(hipotesis))
save(fit_pt2,file=here::here("input/data/proc/fit_pt2.RData"))
sjPlot::tab_model(fit_pt2[c("lnperc16","lnperc016","percarch6")],show.ci = F,wrap.labels = 200,p.style = "stars")
```

```{r just-w02}
# Funciones para renderizar tablas tanto en HTML como en pdf
if (!require("pacman")) install.packages("pacman")  #si falta pacman, instalar
if (!require("tinytex")) install.packages("tinytex")#si falta tinytex, instalar
pacman::p_load(dplyr,lme4,texreg,ggridges,MASS) # librerias
 
load("input/data/proc/vig_respw02.RData")
load(file = here::here("input/data/proc/foliosw1w2.RData"))
df2 <- vig_respw02 %>% 
  # filter(folio_encuestado_1 %in% folios) %>% 
  mutate(
    perc1 = (1 + taxperc),
    just1 = (1 + taxjust),
    perc01 = (.01 + taxperc),
    just01 = (.01 + taxjust),    
    lnperc1 = log(perc1),
    lnjust1 = log(just1),
    lnperc01 = log(perc01),
    lnjust01 = log(just01),    
    lnperc = log(taxperc),
    lnjust = log(taxjust),
    percarch = log(taxperc + sqrt(taxperc ^ 2 + 1)),
    justarch = log(taxjust + sqrt(taxjust ^ 2 + 1)),
    # percR=car::recode(taxperc,"lo:1000=NA"),
    # justR=car::recode(taxjust,"lo:1000=NA"),
    # lnpercR=log(percR),
    # lnjustR=log(justR)
         ) %>% 
  dplyr::select(respondeid,folio_encuestado_1,deck,merit_pref_effort,merit_pref_talent,
         taxperc,
         taxjust,
         perc1, just1,
         perc01,just01,
         # percR,justR,
         lnperc1, lnjust1,
         lnperc01, lnjust01,         
         # lnpercR,lnjustR,
         percarch, justarch,
         sexo_vig, edad_vig,
         apellido_vig, nse_ori_vig, educ_madre_vig,
         necesidades_vig,
         ingresos_vig, educ_vig,sexo_re,edad_re,
         income5, educ) %>% 
  na.omit() %>% 
  arrange(taxjust,taxperc) %>% 
  mutate(merit_pref_effort=as.numeric(merit_pref_effort),
         merit_pref_talent=as.numeric(merit_pref_talent))
dim(df2)

# Hypothesis: Just tax --------------------------------------------------------
m1 <- "sexo_vig+edad_vig"
m2 <- "apellido_vig+nse_ori_vig + educ_madre_vig"
m3 <- "educ_vig + ingresos_vig + necesidades_vig"
# m4 <- "lnperc1 + merit_pref_effort + merit_pref_talent"
m4 <- "lnperc1"
m5 <- "income5 + educ + sexo_re + edad_re"
m6 <- "sexo_vig+edad_vig + apellido_vig+nse_ori_vig + educ_madre_vig + educ_vig + ingresos_vig + necesidades_vig+lnperc1+ income5 + educ + sexo_re + edad_re"
m7 <- "sexo_vig+edad_vig + apellido_vig+nse_ori_vig + educ_madre_vig + educ_vig + ingresos_vig + necesidades_vig+income5 + educ + sexo_re + edad_re + deck"

hipotesis <- c(m1,m2,m3,m4,m5,m6,m7)
# Set the independent variables (IVs)
ivs<- df2 %>% dplyr::select(lnjust1,lnjust01,justarch) %>% names()

# Create the object for each model
models <- list()
for (i in ivs) {
models[[i]] <- paste0(i,"~",hipotesis,"+(1|folio_encuestado_1)")  
}

# Estimate the multilevel models
fits <- list()
for (i in ivs) {
  for (z in models[[i]][1:length(hipotesis)]) {
    fits[[z]] <- lme4::lmer(formula = z, data = df2)
  }
}
fit_jt2 <- fits
# change model names within list
names(fit_jt2) <- paste0(rep(ivs,each=length(hipotesis)),1:length(hipotesis))
save(fit_jt2,file=here::here("input/data/proc/fit_jt2.RData"))
sjPlot::tab_model(fit_jt2[c("lnjust16","lnjust016","justarch6")],show.ci = F,wrap.labels = 200,p.style = "stars")
```

# pooled

```{r longitudinal}
# Funciones para renderizar tablas tanto en HTML como en pdf
 if (!require("pacman")) install.packages("pacman")  #si falta pacman, instalar
 if (!require("tinytex")) install.packages("tinytex")#si falta tinytex, instalar
 pacman::p_load(dplyr,lme4,texreg) # librerias
load(file = here::here("input/data/proc/df_longw1w2.RData"))
load(file = here::here("input/data/proc/foliosw1w2.RData"))

df3 <- 
df_long %>% 
  filter(folio_encuestado_1 %in% folios) %>%
  mutate(
    perc1 = (1 + taxperc),
    just1 = (1 + taxjust),
    perc01 = (.01 + taxperc),
    just01 = (.01 + taxjust),    
    lnperc1 = log(perc1),
    lnjust1 = log(just1),
    lnperc01 = log(perc01),
    lnjust01 = log(just01),    
    lnperc = log(taxperc),
    lnjust = log(taxjust),
    percarch = log(taxperc + sqrt(taxperc ^ 2 + 1)),
    justarch = log(taxjust + sqrt(taxjust ^ 2 + 1)),
    # percR=car::recode(taxperc,"lo:1000=NA"),
    # justR=car::recode(taxjust,"lo:1000=NA"),
    # lnpercR=log(percR),
    # lnjustR=log(justR)
         ) %>% 
  dplyr::select(folio_encuestado_1,
                respondeid,deck,same_deck,
         taxperc,
         taxjust,
         perc1, just1,
         perc01,just01,
         # percR,justR,
         lnperc1, lnjust1,
         lnperc01, lnjust01,         
         # lnpercR,lnjustR,
         percarch, justarch,
         sexo_vig, edad_vig,
         apellido_vig, nse_ori_vig, educ_madre_vig,
         necesidades_vig,
         ingresos_vig, educ_vig,sexo_re,edad_re,
         income5, educ,wave) %>% 
  na.omit() %>% 
  arrange(taxjust,taxperc)
dim(df3)
skimr::skim(df3)

# Hypothesis: Just tax --------------------------------------------------------
m1 <- "sexo_vig+edad_vig + wave"
m2 <- "apellido_vig+nse_ori_vig + educ_madre_vig + wave"
m3 <- "educ_vig + ingresos_vig + necesidades_vig + wave"
m4 <- "lnperc1 + wave"
m5 <- "income5 + educ + sexo_re + edad_re + wave"
m6 <- "sexo_vig+edad_vig + apellido_vig+nse_ori_vig + educ_madre_vig + educ_vig + ingresos_vig + necesidades_vig+lnperc1 +income5 + educ + sexo_re + edad_re + wave"
m7 <- "sexo_vig+edad_vig + apellido_vig+nse_ori_vig + educ_madre_vig + educ_vig + ingresos_vig + necesidades_vig+lnperc1 +income5 + educ + sexo_re + edad_re + wave + deck + same_deck"


hipotesis <- c(m1,m2,m3,m4,m5,m6,m7)
# Set the independent variables (IVs)
ivs<- df3 %>% dplyr::select(lnjust1,lnjust01,justarch) %>% names()

# Create the object for each model
models <- list()
for (i in ivs) {
models[[i]] <- paste0(i,"~",hipotesis,"+(1+ wave|folio_encuestado_1)")  
}

# Estimate the multilevel models
fits <- list()
for (i in ivs) {
  for (z in models[[i]][1:length(hipotesis)]) {
    fits[[z]] <- lme4::lmer(formula = z, data = df3)
  }
}
fit_jtlong <- fits
# change model names within list
names(fit_jtlong) <- paste0(rep(ivs,each=length(hipotesis)),1:length(hipotesis))
save(fit_jtlong,file = here::here("input/data/proc/fit_jtlong.RData"))
knitreg(fit_jtlong[c("justarch1","justarch2","justarch3","justarch4","justarch5","justarch6","justarch7")])
```

# plots 

```{r modelw1}
# Funciones para renderizar tablas tanto en HTML como en pdf
if (!require("pacman")) install.packages("pacman")  #si falta pacman, instalar
if (!require("tinytex")) install.packages("tinytex")#si falta tinytex, instalar
pacman::p_load(dplyr,lme4,texreg,tidyverse) # librerias
load(here::here("input/data/proc/fit_pt1.RData"))
load(here::here("input/data/proc/fit_jt1.RData"))

omit_coef <- c("deck","sexo_reFemale","edad_re2","edad_re3","edad_re4","edad_re5","edad_re6","income5No income/Missing")
sjPlot::tab_model(fit_pt1$lnperc16,fit_jt1$lnjust16,show.ci = F,wrap.labels = 200,p.style = "stars",rm.terms = omit_coef)

nobs(fit_pt1$lnperc16)
nobs(fit_jt1$lnjust16)

sjPlot::plot_model(model = fit_pt1$lnperc16,type = "pred",terms = "educ")

# modelsw1<- sjPlot::plot_model(fit_jt1$lnjust16,rm.terms = omit_coef,show.p = T,show.values = T)
modelsw1<- sjPlot::plot_models(fit_pt1$lnperc16,fit_jt1$lnjust16,rm.terms = omit_coef,show.p = T,show.values = T,dot.size = 2)
modelsw1$data$p.label <- modelsw1$data$p.stars
modelsw1$data$p.label[modelsw1$data$p.label=="n.s."] <- ""
View(modelsw1)

n_i <- nobs(fit_pt1$lnperc16)
n_j <- lme4::ngrps(fit_pt1$lnperc16)

paste0("Obs = ",n_i,", Clusters = ",n_j)
labels1 <- 
c("Gender (ref: Male) Female","45 years (ref: 35 years)","55 years", 
  "Last name: Basque-castillian (ref: Spanish)","European","Indigenous",
  "School origin: Charter (Ref: Public)","Private",
  "Mother's Educ: Secondary (ref: Primary)","Technical","Universitary","Graduate",
  "Education: Secondary (ref: Primary)","Technical","Universitary","Graduate",
  "Income (CLP): $655,000 (ref: $320,500)","$1,200,000","$2,500,000","$4,300,0000",
  "Has Children: Has 1 (ref: Doesn't have)","Has 2","Has 5",
  "Income: Quintile 2 (ref: Quintile 1)", "Quintile 3" ,"Quintile 4","Quintile 5",
  "Education: High school (ref: Primary)", "Technical" ,"Universitary",
  "Perceived income tax (log)"
  )

modelsw1+
  scale_y_continuous(limits = c(-3,7.5)) +
  scale_x_discrete(labels=rev(labels1)) +
  labs(title = "Multilevel lineal models for Perceptions and preferences about income taxes",
        caption=paste0("Obs = ",n_i,", Clusters = ",n_j)
        ) +
  theme(legend.position = "bottom",
        plot.caption = element_text(size = 12),
        axis.text.y=element_text(size=12)) +
  scale_color_discrete(labels=c('Preferences', 'Perceptions')) +
  geom_hline(yintercept = 0,linetype = "dashed") +
  geom_vline(xintercept = 8.5,linetype = "solid",size=1,color="grey") + # respondent level
  annotate("text", x = 8.2, y = 6, label = "Respondent level",size=4) +
  geom_vline(xintercept = 31.5,linetype = "solid",size=1,color="grey") + 
  annotate("text", x = 31, y = 6, label = "Vignette level",size=4) 

ggsave(plot = last_plot(),filename = "modelsw1.png",device = "png",
       path = here::here("output"),width = 1.75,height = 1.5,units = "cm",scale = 16)
```

```{r modelw2}
# Funciones para renderizar tablas tanto en HTML como en pdf
if (!require("pacman")) install.packages("pacman")  #si falta pacman, instalar
if (!require("tinytex")) install.packages("tinytex")#si falta tinytex, instalar
pacman::p_load(dplyr,lme4,texreg,tidyverse) # librerias
load(here::here("input/data/proc/fit_pt2.RData"))
load(here::here("input/data/proc/fit_jt2.RData"))

omit_coef <- c("deck","sexo_reFemale","edad_re2","edad_re3","edad_re4","edad_re5","edad_re6","income5No income/Missing")
sjPlot::tab_model(fit_pt2$lnperc16,fit_jt2$lnjust16,show.ci = F,wrap.labels = 200,p.style = "stars",rm.terms = omit_coef)

# modelsw1<- sjPlot::plot_model(fit_jt1$lnjust16,rm.terms = omit_coef,show.p = T,show.values = T)
modelsw2<- sjPlot::plot_models(fit_pt2$lnperc16,fit_jt2$lnjust16,rm.terms = omit_coef,show.p = T,show.values = T,dot.size = 2)
modelsw2$data$p.label <- modelsw2$data$p.stars
modelsw2$data$p.label[modelsw2$data$p.label=="n.s."] <- ""
View(modelsw2)

n_i <- nobs(fit_pt2$lnperc16)
n_j <- lme4::ngrps(fit_pt2$lnperc16)

paste0("Obs = ",n_i,", Clusters = ",n_j)
labels1 <- 
c("Gender (ref: Male) Female","45 years (ref: 35 years)","55 years", 
  "Last name: Basque-castillian (ref: Spanish)","European","Indigenous",
  "School origin: Charter (Ref: Public)","Private",
  "Mother's Educ: Secondary (ref: Primary)","Technical","Universitary","Graduate",
  "Education: Secondary (ref: Primary)","Technical","Universitary","Graduate",
  "Income (CLP): $655,000 (ref: $320,500)","$1,200,000","$2,500,000","$4,300,0000",
  "Has Children: Has 1 (ref: Doesn't have)","Has 2","Has 5",
  "Income: Quintile 2 (ref: Quintile 1)", "Quintile 3" ,"Quintile 4","Quintile 5",
  "Education: High school (ref: Primary)", "Technical" ,"Universitary",
  "Perceived income tax (log)"
  )

modelsw2+
  scale_y_continuous(limits = c(-3,7.5)) +
  scale_x_discrete(labels=rev(labels1)) +
  labs(title = "Perceived and Preferred income tax (Wave 2)",
        caption=paste0("Obs = ",n_i,", Clusters = ",n_j)
        ) +
  theme(legend.position = "bottom",
        plot.caption = element_text(size = 12),
        axis.text.y=element_text(size=12)) +
  geom_hline(yintercept = 0,linetype = "dashed") +
  geom_vline(xintercept = 8.5,linetype = "solid",size=1,color="grey") + # respondent level
  annotate("text", x = 8.2, y = 6, label = "Respondent level",size=4) +
  geom_vline(xintercept = 31.5,linetype = "solid",size=1,color="grey") + 
  annotate("text", x = 31, y = 6, label = "Vignette level",size=4) 

ggsave(plot = last_plot(),filename = "modelsw2.png",device = "png",
       path = here::here("output"),width = 1.75,height = 1.5,units = "cm",scale = 18)
```

```{r longitudinalw1w2}
# Funciones para renderizar tablas tanto en HTML como en pdf
if (!require("pacman")) install.packages("pacman")  #si falta pacman, instalar
if (!require("tinytex")) install.packages("tinytex")#si falta tinytex, instalar
pacman::p_load(dplyr,lme4,texreg,tidyverse) # librerias
load(file = here::here("input/data/proc/fit_jtlong.RData"))

omit_coef <- c("deck","same_deck","sexo_reFemale","edad_re2","edad_re3","edad_re4","edad_re5","edad_re6","income5No income/Missing")
sjPlot::tab_model(fit_jtlong$lnjust017,show.ci = F,wrap.labels = 200,p.style = "stars",rm.terms = omit_coef)

# modelsw1<- sjPlot::plot_model(fit_jt1$lnjust16,rm.terms = omit_coef,show.p = T,show.values = T)
modelslong<- sjPlot::plot_model(fit_jtlong$lnjust017,rm.terms = omit_coef,show.p = T,show.values = T,dot.size = 2,show.intercept = F)
modelslong$data$p.label <- modelslong$data$p.stars
modelslong$data$p.label[modelslong$data$p.label=="n.s."] <- ""
# View(modelslong)
n_i <- nobs(fit_jtlong$lnjust017)
n_j <- lme4::ngrps(fit_jtlong$lnjust017)

paste0("Obs = ",n_i,", Clusters = ",n_j)
labels1 <- 
c("Gender (ref: Male) Female","45 years (ref: 35 years)","55 years", 
  "Last name: Basque-castillian (ref: Spanish)","European","Indigenous",
  "School origin: Charter (Ref: Public)","Private",
  "Mother's Educ: Secondary (ref: Primary)","Technical","Universitary","Graduate",
  "Education: Secondary (ref: Primary)","Technical","Universitary","Graduate",
  "Income (CLP): $655,000 (ref: $320,500)","$1,200,000","$2,500,000","$4,300,0000",
  "Has Children: Has 1 (ref: Doesn't have)","Has 2","Has 5",
   "Perceived income tax (log)",
  "Income: Quintile 2 (ref: Quintile 1)", "Quintile 3" ,"Quintile 4","Quintile 5",
  "Education: High school (ref: Primary)", "Technical" ,"Universitary",
  "Wave (ref: wave 1)",
  "Same deck (ref: No)"
  )

modelslong+
  scale_y_continuous(limits = c(-3,7.5)) +
  scale_x_discrete(labels=rev(labels1)) +
  labs(title = "Preferred income tax (Longitudinal)",
        caption=paste0("Obs = ",n_i,", Clusters = ",n_j)
        ) +
  theme(legend.position = "bottom",
        plot.caption = element_text(size = 12),
        axis.text.y=element_text(size=12)) +
  geom_hline(yintercept = 0,linetype = "dashed") +
  geom_vline(xintercept = 9.5,linetype = "solid",size=1,color="grey") + # respondent level
  annotate("text", x = 9.2, y = 6, label = "Respondent level",size=4) +
  geom_vline(xintercept = 33.5,linetype = "solid",size=1,color="grey") + 
  annotate("text", x = 33, y = 6, label = "Vignette level",size=4) 

ggsave(plot = last_plot(),filename = "long.png",device = "png",
       path = here::here("output"),width = 1.75,height = 1.5,units = "cm",scale = 12)
```


tobit model:

https://stats.oarc.ucla.edu/r/dae/tobit-models/#:~:text=The%20tobit%20model%2C%20also%20called,below%20and%20above%2C%20respectively).

https://docs.zeligproject.org/articles/zelig_tobit.html se ve como la mejor opción


```{r tobit}
# Funciones para renderizar tablas tanto en HTML como en pdf
 if (!require("pacman")) install.packages("pacman")  #si falta pacman, instalar
 if (!require("tinytex")) install.packages("tinytex")#si falta tinytex, instalar
 pacman::p_load(dplyr,lme4,texreg,ggridges,VGAM) # librerias
load("input/data/proc/vig_respw01.RData")

df1 <- vig_respw01 %>% 
  mutate(
    perc1 = (1 + taxperc),
    just1 = (1 + taxjust),
    perc01 = (.01 + taxperc),
    just01 = (.01 + taxjust),    
    lnperc1 = log(perc1),
    lnjust1 = log(just1),
    lnperc01 = log(perc01),
    lnjust01 = log(just01),    
    lnperc = log(taxperc),
    lnjust = log(taxjust),
    percarch = log(taxperc + sqrt(taxperc ^ 2 + 1)),
    justarch = log(taxjust + sqrt(taxjust ^ 2 + 1)),
    # percR=car::recode(taxperc,"lo:1000=NA"),
    # justR=car::recode(taxjust,"lo:1000=NA"),
    # lnpercR=log(percR),
    # lnjustR=log(justR)
         ) %>% 
  dplyr::select(respondeid,
         taxperc,
         taxjust,
         perc1, just1,
         perc01,just01,
         # percR,justR,
         lnperc1, lnjust1,
         lnperc01, lnjust01,         
         # lnpercR,lnjustR,
         percarch, justarch,
         sexo_vig, edad_vig,
         apellido_vig, nse_ori_vig, educ_madre_vig,
         necesidades_vig,
         ingresos_vig, educ_vig,sexo_re,edad_re,
         income5, educ) %>% 
  na.omit() %>% 
  arrange(taxjust,taxperc)
dim(df1)


modelo<- vglm(taxjust ~ sexo_vig+edad_vig + apellido_vig+nse_ori_vig + educ_madre_vig + educ_vig + ingresos_vig + necesidades_vig+lnperc1 +income5 + educ + sexo_re + edad_re, tobit(Lower = 0), data = df1)

```
